<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÁáüÈ§äÊé•Êé•Ê®Ç</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
    }
    .screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100dvh;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: none;
    }
    .active {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .hotspot {
      position: absolute;
      width: 500px;
      height: 100px;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      cursor: pointer;
    }
    canvas {
      display: block;
      pointer-events: none;
      z-index: -1;
      position: relative;
    }
    #allowOrientationBtn {
      padding: 15px 25px;
      font-size: 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #ffcc00;
    }
  </style>
</head>
<body>
  <!-- üöÄ ËºâÂÖ•Áï´Èù¢ -->
  <div id="loading" class="screen active" style="background:black; color:white;">
    <div id="loadingText" style="font-size: 28px;">ËºâÂÖ•‰∏≠...</div>
  </div>

  <!-- È¶ñÈ†Å -->
  <div id="home" class="screen" style="background-image: url('images/cover.jpg');">
    <div class="hotspot" onclick="showScreen('intro')"></div>
  </div>

  <!-- Intro (ÂÖÅË®±ÊñπÂêë) -->
  <div id="intro" class="screen" style="background-image: url('images/intro.jpg');">
    <button id="allowOrientationBtn">ÂÖÅË®±Ë£ùÁΩÆÊñπÂêë</button>
  </div>

  <!-- K1 ÈÅéÂ†¥ -->
  <div id="K1Transition" class="screen" style="background-image: url('images/K1.jpg');">
    <div class="hotspot" onclick="startGame()"></div>
  </div>

  <!-- ÈÅäÊà≤ -->
  <div id="gameCanvasContainer" class="screen">
    <canvas id="gameCanvas"></canvas>
  </div>

  <div id="betweenLevel" class="screen">
    <div class="hotspot" onclick="nextLevelStart()"></div>
  </div>

  <div id="result" class="screen">
    <div id="scoreResult"></div>
    <div class="hotspot" onclick="location.reload()"></div>
  </div>

<script>
/* ================= Èü≥Ê®ÇËàáÈü≥Êïà ================= */
const bgm = new Audio('sounds/bgm.mp3');
bgm.loop = true;
bgm.volume = 0.1;

let audioUnlocked = false;
async function unlockAudioOnce() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  try {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    const ctx = new AC();
    await ctx.resume();
    const buffer = ctx.createBuffer(1, 1, 22050);
    const src = ctx.createBufferSource();
    src.buffer = buffer;
    src.connect(ctx.destination);
    src.start(0);
    setTimeout(() => { try { ctx.close(); } catch(e){} }, 120);
  } catch (e) {
    console.log('unlockAudioOnce Â§±ÊïóÔºö', e);
  }
}

// Èü≥ÊïàÊ±†Ôºà‰∏çÊúÉÊñ∑Èü≥Ôºâ
function createSoundPool(src, poolSize = 6) {
  const pool = Array.from({ length: poolSize }, () => {
    const audio = new Audio(src);
    audio.preload = "auto";
    return audio;
  });
  function getIdleAudio() {
    for (const a of pool) {
      if (a.paused || a.ended) return a;
    }
    return pool[0];
  }
  async function safePlay(volume) {
    let a = getIdleAudio();
    try {
      a.currentTime = 0;
      a.volume = volume;
      a.muted = false;
      await a.play();
    } catch (err) {
      console.warn("Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:", err);
    }
  }
  return {
    play(volume = 1) { safePlay(volume); },
    preload() { pool.forEach(a => { try { a.load(); } catch (e) {} }); },
    _all() { return pool; }
  };
}

const clickSoundPool = createSoundPool('sounds/click.mp3');
const goodSoundPool  = createSoundPool('sounds/good.mp3');
const badSoundPool   = createSoundPool('sounds/bad.mp3');
const wrongSoundPool = createSoundPool('sounds/wrong.mp3');

function handleClickFeedback() {
  clickSoundPool.play();
  if (navigator.vibrate) navigator.vibrate(80);
}

/* ================= Áï´Èù¢ÂàáÊèõ ================= */
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ================= ÈÅäÊà≤Ê†∏ÂøÉ ================= */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const basket = { x: canvas.width/2 - 60, y: canvas.height-100, width:120, height:80 };
let currentFood = null;
let foodQueue = [], score = 0, level = 1;
let stats = { 1: { good:0, bad:0 }, 2: { good:0, bad:0 }, 3: { good:0, bad:0 } };
let bgTimeout = null;

const bgImages = { 0: new Image(), 1: new Image(), 2: new Image(), 3: new Image() };
bgImages[0].src = "images/bg0.jpg";
bgImages[1].src = "images/bg1.jpg";
bgImages[2].src = "images/bg2.jpg";
bgImages[3].src = "images/bg3.jpg";
let bgImg = bgImages[0];

const transitionScreens = { 1: "images/K2.jpg", 2: "images/K3.jpg" };
const bowlImg = new Image(); bowlImg.src = 'images/bowl.png';

 const allFoods = [
      { file: "GM1.png", type: "meat",       health: "good" },
      { file: "GM3.png", type: "meat",       health: "good" },
      { file: "GM4.png", type: "meat",       health: "good" },
      { file: "GM5.png", type: "meat",       health: "good" },
      { file: "BM2.png", type: "meat",       health: "bad"  },
      { file: "BM3.png", type: "meat",       health: "bad"  },
      { file: "GV1.png", type: "vegetable",  health: "good" },
      { file: "GV2.png", type: "vegetable",  health: "good" },
      { file: "GV3.png", type: "vegetable",  health: "good" },
      { file: "GV4.png", type: "vegetable",  health: "good" },
      { file: "GV5.png", type: "vegetable",  health: "good" },
      { file: "GStrach1.png", type: "rice",  health: "good" },
      { file: "GStrach3.png", type: "rice",  health: "good" },
      { file: "BStrach1.png", type: "rice",  health: "bad"  },
      { file: "BStrach2.png", type: "rice",  health: "bad"  },
      { file: "BStrach3.png", type: "rice",  health: "bad"  },
    ];


// === Intro ÁöÑÂÖÅË®±ÊñπÂêëÊåâÈàï ===
document.getElementById("allowOrientationBtn").onclick = async () => {
  if (typeof DeviceOrientationEvent !== "undefined" &&
      typeof DeviceOrientationEvent.requestPermission === "function") {
    try {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res === "granted") {
        window.addEventListener("deviceorientation", handleOrientation);
        showScreen("K1Transition");
      } else {
        alert("Êú™ÂÖÅË®±ÊñπÂêëÊ¨äÈôêÔºåÈÅäÊà≤ÂèØËÉΩÁÑ°Ê≥ïÊìç‰Ωú");
      }
    } catch (err) {
      alert("ÊñπÂêëË´ãÊ±ÇÂ§±ÊïóÔºö" + err);
    }
  } else {
    window.addEventListener("deviceorientation", handleOrientation);
    showScreen("K1Transition");
  }
};

/* === StartGame === */
function startGame() {
  unlockAudioOnce();
  showScreen("loading");
  const loadingText = document.getElementById("loadingText");
  loadingText.textContent = "ËºâÂÖ•ËÉåÊôØÈü≥Ê®Ç‰∏≠...";

  bgm.addEventListener("canplaythrough", () => {
    loadingText.textContent = "ËºâÂÖ•ÂÆåÊàêÔºåÈñãÂßãÈÅäÊà≤ÔºÅ";

    const allSfx = [
      ...clickSoundPool._all(),
      ...goodSoundPool._all(),
      ...badSoundPool._all(),
      ...wrongSoundPool._all()
    ];
    allSfx.forEach(a => { try { a.load(); } catch(e){} });

    setTimeout(() => {
      showScreen("gameCanvasContainer");
      level = 1;
      score = 0;
      prepareLevel();
      loop();
      bgm.play().catch(() => console.log("Èü≥Ê®ÇÊí≠ÊîæÂ§±Êïó"));
    }, 800);
  }, { once: true });

  try { bgm.load(); } catch(e) {}
}

/* === ÊñπÂêëÊÑüÊáâ === */
function handleOrientation(event) {
  const tilt = event.gamma;
  if (tilt != null) {
    basket.x += tilt * 0.5;
    basket.x = Math.max(0, Math.min(canvas.width - basket.width, basket.x));
  }
}

/* ========== ÂÖ∂‰ªñÈÅäÊà≤ÂáΩÊï∏ÔºàÁ∞°ÂåñÁâàÔºâ ========== */
function prepareLevel(){ foodQueue = [allFoods[0], allFoods[1], allFoods[2]]; spawnFood(); }
function spawnFood(){ if (foodQueue.length>0) { const f=foodQueue.shift(); const img=new Image(); img.onload=()=>{ currentFood={...f,image:img,x:100,y:0,size:80,speed:3}; }; img.src=`images/${f.file}`; } }
function update(){ if(currentFood){ currentFood.y+=currentFood.speed; if(currentFood.y>canvas.height){ currentFood=null; spawnFood(); } } }
function draw(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(bgImg.complete) ctx.drawImage(bgImg,0,0,canvas.width,canvas.height); if(bowlImg.complete) ctx.drawImage(bowlImg,basket.x,basket.y,basket.width,basket.height); if(currentFood?.image?.complete) ctx.drawImage(currentFood.image,currentFood.x,currentFood.y,currentFood.size,currentFood.size); }
function loop(){ update(); draw(); requestAnimationFrame(loop); }

/* === È¶ñÊ¨°ËºâÂÖ•ÔºöLoading ‚Üí Home === */
window.addEventListener("load", () => {
  const loadingText = document.getElementById("loadingText");
  let loaded = 0;
  const toLoad = [bgm, "images/cover.jpg", "images/intro.jpg", "images/K1.jpg"];
  function checkDone() {
    loaded++;
    loadingText.textContent = `ËºâÂÖ•‰∏≠... ${loaded}/${toLoad.length}`;
    if (loaded >= toLoad.length) {
      setTimeout(() => { showScreen("home"); }, 500);
    }
  }
  bgm.addEventListener("canplaythrough", checkDone, { once: true });
  try { bgm.load(); } catch(e) {}
  toLoad.slice(1).forEach(src => { const img=new Image(); img.onload=checkDone; img.onerror=checkDone; img.src=src; });
  showScreen("loading");
});
</script>
</body>
</html>
