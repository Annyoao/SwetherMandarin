<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>營養接接樂</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100dvh; width: 100vw; overflow: hidden; }
    .screen {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100dvh;
      background-size: cover; background-position: center; background-repeat: no-repeat;
      display: none;
    }
    .active { display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .hotspot {
      position: absolute; width: 500px; height: 100px; bottom: 80px; left: 50%;
      transform: translateX(-50%); cursor: pointer;
    }

    /* 新增：簡單的允許按鈕樣式（最原始） */
    #permissionBox {
      position: absolute;
      bottom: 150px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
    }
    #permissionBox p { margin: 0; padding: 6px 8px; background: rgba(255,255,255,0.9); border-radius: 6px; color: #000; font-size: 16px;}
    #allowOrientationBtn {
      padding: 10px 18px;
      font-size: 16px;
      border: 1px solid #333;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
    }

    canvas { display: block; pointer-events: none; z-index: -1; position: relative; }
  </style>
</head>
<body>

  <!-- 載入（預設 active） -->
  <div id="loading" class="screen active" style="background: black; color: white; display:flex;justify-content:center;align-items:center;flex-direction:column;">
    <div id="loadingText" style="font-size:28px">載入中...</div>
  </div>

  <!-- 首頁（封面） -->
  <div id="home" class="screen" style="background-image: url('images/cover.jpg');">
    <div class="hotspot" onclick="showScreen('intro')"></div>
  </div>

  <!-- intro -->
  <div id="intro" class="screen" style="background-image: url('images/intro.jpg');">
  <div class="hotspot" onclick="showScreen('permission')"></div>
  </div>

  <!-- 新增允許頁（黑底白字） -->
<div id="permission" class="screen" style="background:black; color:white; flex-direction:column;justify-content:center;align-items:center;">
  <p style="font-size:45px; margin-bottom:40px;text-align:center;max-width:500px;line-height:1.8;">請按下「允許」<br> 開啟手機搖晃功能</p>
  <button id="allowOrientationBtn" style="padding:40px 70px;font-size:40px;border:2px solid #fff;background:#000;color:#fff;border-radius:12px;cursor:pointer;">
    ✅ 允許
  </button>
</div>

  <!-- K1 過場 -->
  <div id="K1Transition" class="screen" style="background-image: url('images/K1.jpg');">
    <div class="hotspot" onclick="startGame()"></div>
  </div>

  <div id="gameCanvasContainer" class="screen">
    <canvas id="gameCanvas"></canvas>
  </div>

  <div id="betweenLevel" class="screen">
    <div class="hotspot" onclick="nextLevelStart()"></div>
  </div>

  <div id="result" class="screen">
    <div id="scoreResult"></div>
    <div class="hotspot" onclick="location.reload()"></div>
  </div>

<script>
/* --- 音樂、音效池（保留你原本的實作，可按需修改） --- */
const bgm = new Audio('sounds/bgm.mp3'); bgm.loop = true; bgm.volume = 0.1;
let audioUnlocked = false;
async function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  try {
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!AC) return;
    const ctx = new AC();
    await ctx.resume();
    const buffer = ctx.createBuffer(1,1,22050);
    const src = ctx.createBufferSource();
    src.buffer = buffer; src.connect(ctx.destination); src.start(0);
    setTimeout(()=>{ try{ ctx.close(); } catch(e){} }, 120);
  } catch(e){ console.log('unlockAudioOnce fail', e); }
}

function createSoundPool(src, poolSize=6){
  const pool = Array.from({length:poolSize}, ()=> { const a=new Audio(src); a.preload='auto'; return a; });
  function getIdleAudio(){
    for(const a of pool) if(a.paused || a.ended) return a;
    return null;
  }
  async function safePlay(volume){
    let a = getIdleAudio();
    if(!a) a = new Audio(src); // 全忙就 clone 新音軌
    try{ a.currentTime = 0; a.volume = volume; a.muted=false; await a.play(); } catch(e){ console.warn('sfx fail', e); }
  }
  return { play(vol=1){ safePlay(vol); }, preload(){ pool.forEach(a=>{try{a.load()}catch(e){} }); }, _all(){ return pool; } };
}

const clickSoundPool = createSoundPool('sounds/click.mp3');
const goodSoundPool = createSoundPool('sounds/good.mp3',10);
const badSoundPool = createSoundPool('sounds/bad.mp3',8);
const wrongSoundPool = createSoundPool('sounds/wrong.mp3',6);

function warmUpSoundPools(){ [clickSoundPool,goodSoundPool,badSoundPool,wrongSoundPool].forEach(p=>p.preload()); }
function handleClickFeedback(){ clickSoundPool.play(); if(navigator.vibrate) navigator.vibrate(80); }

/* --- 畫布與遊戲變數 --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight;

const basket = { x: canvas.width/2 - 60, y: canvas.height - 100, width: 120, height: 80 };
let currentFood = null, foodQueue = [], score = 0, level = 1;
let stats = {1:{good:0,bad:0},2:{good:0,bad:0},3:{good:0,bad:0}};
let bgTimeout = null;
let orientationAllowed = false; // <- 記錄是否已由按鈕授權過

const bgImages = { 0:new Image(),1:new Image(),2:new Image(),3:new Image() };
bgImages[0].src = 'images/bg0.jpg'; bgImages[1].src = 'images/bg1.jpg'; bgImages[2].src = 'images/bg2.jpg'; bgImages[3].src = 'images/bg3.jpg';
let bgImg = bgImages[0];
const bowlImg = new Image(); bowlImg.src = 'images/bowl.png';
const transitionScreens = {1:'images/K2.jpg', 2:'images/K3.jpg'};

const allFoods = [
  { file:"GM1.png", type:"meat", health:"good" },
  { file:"GM3.png", type:"meat", health:"good" },
  { file:"GM4.png", type:"meat", health:"good" },
  { file:"BM2.png", type:"meat", health:"bad" },
  { file:"BM3.png", type:"meat", health:"bad" },
  { file:"GV1.png", type:"vegetable", health:"good" },
  { file:"GV2.png", type:"vegetable", health:"good" },
  { file:"GV3.png", type:"vegetable", health:"good" },
  { file:"GV4.png", type:"vegetable", health:"good" },
  { file:"GV5.png", type:"vegetable", health:"good" },
  { file:"GStrach1.png", type:"rice", health:"good" },
  { file:"GStrach3.png", type:"rice", health:"good" },
  { file:"BStrach1.png", type:"rice", health:"bad" },
  { file:"BStrach2.png", type:"rice", health:"bad" },
  { file:"BStrach3.png", type:"rice", health:"bad" },
];
// 預載所有食物圖片，避免 onload 沒觸發
allFoods.forEach(f => {
  const img = new Image();
  img.src = `images/${f.file}`;
  f.preloadedImage = img; // 把圖片存到物件裡
});
  
/* --- 畫面切換 helper --- */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
}

/* --- 允許按鈕 的行為（關鍵）--- */
const allowBtn = document.getElementById('allowOrientationBtn');
allowBtn.addEventListener('click', async (e) => {
  handleClickFeedback(); // 音效 + 震動（使用者手勢）
  // iOS 要求 requestPermission() 必須在使用者操作中呼叫
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res === 'granted') {
        orientationAllowed = true;
        window.addEventListener('deviceorientation', handleOrientation);
        // 進入 K1 過場（按鈕授權成功後）
        showScreen('K1Transition');
      } else {
        alert('您未允許裝置方向存取，請開啟權限後再試。');
      }
    } catch (err) {
      console.warn('requestPermission error', err);
      alert('授權失敗或被拒。');
    }
  } else {
    // Android / 桌面：不需要 requestPermission，直接綁事件
    orientationAllowed = true;
    window.addEventListener('deviceorientation', handleOrientation);
    showScreen('K1Transition');
  }
});

/* --- startGame：從 K1 過場按下 start 才會真正進入 loading 並啟動遊戲 --- */
function startGame(){
  // 若沒有事先授權（理想流程：玩家先按 allow），在這裡我們也可嘗試再次請求（此 click 也是使用者手勢）
  if(!orientationAllowed && typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
    // 嘗試直接請求（會在 iOS 彈出）
    DeviceOrientationEvent.requestPermission().then(res=>{
      if(res === 'granted'){ orientationAllowed = true; window.addEventListener('deviceorientation', handleOrientation); }
      // 不論是否同意，我們繼續 loading → game，但強烈建議玩家事先點允許
      beginLoadingToGame();
    }).catch(err=>{
      console.warn('requestPermission in startGame failed', err);
      beginLoadingToGame();
    });
  } else {
    beginLoadingToGame();
  }
}

function beginLoadingToGame(){
  unlockAudioOnce();
  showScreen('loading');
  const loadingText = document.getElementById('loadingText');
  loadingText.textContent = '載入背景音樂中...';
  // 等 BGM canplaythrough（若網速慢，loading 會顯示）
  bgm.addEventListener('canplaythrough',async  () => {
    loadingText.textContent = '載入完成，開始遊戲！';
    // 預載音效
    [clickSoundPool,goodSoundPool,badSoundPool,wrongSoundPool].forEach(p=>p.preload());
     warmUpSoundPools();
    
     // 嘗試播放音樂（必須要有使用者互動才能成功）236-245為保險機制:避免瀏覽器擋音樂
    try {
      await bgm.play();
    } catch(e) {
      console.log('bgm play failed, 等待使用者互動再播');
      // 提示玩家點一下螢幕才能播音樂
      document.body.addEventListener('click', () => {
        bgm.play().catch(err=>console.log('still failed', err));
      }, { once:true });
    }
    
    // 開始遊戲
    showScreen('gameCanvasContainer');
    level = 1; score = 0;
    prepareLevel(); loop();
    bgm.play().catch(()=>console.log('bgm play failed'));
  }, { once: true });
  try{ bgm.load(); } catch(e){}
}

/* --- level / spawn / 判定 / audio on catch --- */
function prepareLevel(){
  foodQueue = [];
  const correctFoods = allFoods.filter(f => (level===1 && f.type==='meat' && f.health==='good') || (level===2 && f.type==='vegetable' && f.health==='good') || (level===3 && f.type==='rice' && f.health==='good'));
  const incorrectFoods = allFoods.filter(f => !correctFoods.includes(f));
  for(let i=0;i<10;i++){ foodQueue.push(correctFoods[Math.floor(Math.random()*correctFoods.length)]); foodQueue.push(incorrectFoods[Math.floor(Math.random()*incorrectFoods.length)]); }
  spawnFood(); startLevelTimer();
}
function spawnFood(){
  if(currentFood || foodQueue.length===0) return;
  const f = foodQueue.shift();
  currentFood = {
    ...f,
    image: f.preloadedImage,  // ✅ 直接用預載好的圖片
    x: Math.random() * (canvas.width - 80),
    y: 0,
    size: 90,
    speed: 3
  };
}

let hitboxDifficulty = 'hard';
const HITBOX_PRESETS = { easy:{shrinkX:5,verticalTolerance:40}, normal:{shrinkX:15,verticalTolerance:25}, hard:{shrinkX:25,verticalTolerance:15} };
const HITBOX_CUSTOM = { shrinkX:20, verticalTolerance:20 };
function getHitboxParams(){ if(hitboxDifficulty==='custom') return HITBOX_CUSTOM; return HITBOX_PRESETS[hitboxDifficulty]||HITBOX_PRESETS.normal; }
function isColliding(food,basket){
  const { shrinkX, verticalTolerance } = getHitboxParams();
  const foodBottom = food.y + food.size;
  const foodCenterX = food.x + food.size/2;
  const plateTop = basket.y; const plateLeft = basket.x + shrinkX; const plateRight = basket.x + basket.width - shrinkX;
  return (foodBottom >= plateTop && foodBottom <= plateTop + verticalTolerance && foodCenterX > plateLeft && foodCenterX < plateRight);
}
function update(){
  if(!currentFood) return;
  currentFood.y += currentFood.speed;
  const caught = isColliding(currentFood, basket);
  const missed = currentFood.y > canvas.height;
  if(caught || missed){
    if(caught) handleCatch(currentFood);
    currentFood = null;
    if(foodQueue.length>0) spawnFood(); else showTransition();
  }
}
function handleCatch(food){
  if(navigator.vibrate) navigator.vibrate(30);
  if(food.health === 'bad'){ score -= 2; stats[level].bad++; bgImg = bgImages[3]; badSoundPool.play(); }
  else if( (level===1 && food.type==='meat') || (level===2 && food.type==='vegetable') || (level===3 && food.type==='rice') ){ score += 2; stats[level].good++; bgImg = bgImages[1]; goodSoundPool.play(); }
  else { score -= 1; stats[level].bad++; bgImg = bgImages[2]; wrongSoundPool.play(); }
  if(bgTimeout) clearTimeout(bgTimeout); bgTimeout = setTimeout(()=>{ bgImg = bgImages[0]; }, 3000);
}

/* --- 計時、繪製、主迴圈 --- */
let levelTime = 65, timeLeft = levelTime, timerInterval = null;
function startLevelTimer(){ timeLeft = levelTime; clearInterval(timerInterval); timerInterval = setInterval(()=>{ timeLeft--; if(timeLeft<=0){ clearInterval(timerInterval); showTransition(); } }, 1000); }
function draw(){
  if(bgImg.complete) ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
  if(bowlImg.complete) ctx.drawImage(bowlImg, basket.x, basket.y, basket.width, basket.height);
  if(currentFood?.image?.complete) ctx.drawImage(currentFood.image, currentFood.x, currentFood.y, currentFood.size, currentFood.size);
  ctx.font = "bold 24px sans-serif"; ctx.fillStyle = "black";
  ctx.fillText(`關卡 ${level} 分數:${score}`, 10, 40);
  ctx.textAlign = "right"; ctx.fillText(`剩餘時間: ${timeLeft}s`, canvas.width - 10, 40); ctx.textAlign = "left";
  ctx.fillText(getLevelTarget(level), 10, 80);
}
function getLevelTarget(l){ if(l===1) return "本關目標：只吃健康蛋白質"; if(l===2) return "本關目標：只吃蔬菜"; if(l===3) return "本關目標：只吃健康澱粉"; return ""; }
function loop(){ update(); draw(); if(level<=3) requestAnimationFrame(loop); }
function showTransition(){ clearInterval(timerInterval); if(level<3){ document.getElementById('betweenLevel').style.backgroundImage = `url('${transitionScreens[level]}')`; showScreen('betweenLevel'); } else showResult(); }
function nextLevelStart(){ level++; showScreen('gameCanvasContainer'); prepareLevel(); }
function showResult(){ clearInterval(timerInterval); showScreen('result'); const bg = score>=20 ? 'result1.jpg' : score>=10 ? 'result2.jpg' : 'result3.jpg'; document.getElementById('result').style.backgroundImage = `url('images/${bg}')`; document.getElementById('scoreResult').innerHTML = ''; setTimeout(()=>{ document.getElementById('scoreResult').innerHTML = `<div style="font-size:60px;color:red;font-weight:bold;text-shadow:2px 2px 4px white;margin-bottom:100px;">${score} 分！</div>`; }, 800); }

/* --- 裝置方向處理 --- */
function handleOrientation(ev){
  const tilt = ev.gamma;
  if(tilt != null){ basket.x += tilt * 0.5; basket.x = Math.max(0, Math.min(canvas.width - basket.width, basket.x)); }
}

/* --- 頁面按鈕包裹的 click 聲音處理（hotspot 加強） --- */
window.onload = () => {
  document.querySelectorAll('.hotspot').forEach(button=>{
    const original = button.onclick;
    button.onclick = (e) => { handleClickFeedback(); if(typeof original === 'function') original.call(button, e); };
  });
};

/* --- preload: 載入必要資源，載完顯示 home --- */
window.addEventListener('load', ()=>{
  const loadingText = document.getElementById('loadingText');
  let loaded = 0;
  const toLoad = [bgm, 'images/cover.jpg', 'images/intro.jpg', 'images/K1.jpg'];
  function checkDone(){ loaded++; loadingText.textContent = `載入中... ${loaded}/${toLoad.length}`; if(loaded >= toLoad.length){ setTimeout(()=> showScreen('home'), 500); } }
  bgm.addEventListener('canplaythrough', checkDone, { once:true }); try{ bgm.load(); } catch(e){}
  toLoad.slice(1).forEach(src => { const img=new Image(); img.onload=checkDone; img.onerror=checkDone; img.src=src; });
  showScreen('loading');
});
</script>
</body>
</html>
